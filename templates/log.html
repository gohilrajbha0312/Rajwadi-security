<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rajwadi Security - Logs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/cyber.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar">
                <h4 class="mb-4">Rajwadi Security</h4>
                <nav class="nav flex-column">
                    <a class="nav-link" href="/">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </a>
                    <a class="nav-link" href="/eep">
                        <i class="fas fa-shield-alt"></i> EEP
                    </a>
                    <a class="nav-link active" href="/log">
                        <i class="fas fa-list"></i> Log
                    </a>
                    <a class="nav-link" href="/soc-helper">
                        <i class="fas fa-user-secret"></i> SOC Helper (AI Help)
                    </a>
                    <a class="nav-link mt-4" href="/logout">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Security Logs</h2>
                    <div>
                        <button class="btn btn-outline me-2" onclick="refreshLogs()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                        <button class="btn btn-outline" onclick="exportLogs()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                    </div>
                </div>

                <!-- Real-Time Log Viewer Filters (moved to top) -->
                <div class="filter-section mb-4">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-2">
                            <label class="form-label">Level</label>
                            <select class="form-select" id="filterLevel" onchange="filterLogTable()">
                                <option value="">All</option>
                                <option value="INFO">INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                                <option value="SUCCESS">SUCCESS</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Source</label>
                            <select class="form-select" id="filterSource" onchange="filterLogTable()">
                                <option value="">All</option>
                                <option value="web">web</option>
                                <option value="system">system</option>
                                <option value="security">security</option>
                                <option value="network">network</option>
                                <option value="application">application</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Time Range</label>
                            <select class="form-select" id="filterTimeRange" onchange="filterLogTable()">
                                <option value="all">All</option>
                                <option value="1h">Last Hour</option>
                                <option value="6h">Last 6 Hours</option>
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Start Time</label>
                            <input type="datetime-local" class="form-control" id="filterStartTime" onchange="filterLogTable()">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">End Time</label>
                            <input type="datetime-local" class="form-control" id="filterEndTime" onchange="filterLogTable()">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control" id="filterSearch" placeholder="Search any field..." oninput="filterLogTable()">
                        </div>
                    </div>
                </div>

                <!-- Log Entries -->
                <div class="card">
                    <div class="card-body p-0">
                        <div id="logEntries">
                            <!-- Log entries will be dynamically added here -->
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-outline" onclick="fetchLogs()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Logs
                    </button>
                </div>
                <table class="log-table neon-table" id="logTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Level</th>
                            <th>Source</th>
                            <th>Event ID</th>
                            <th>Process ID</th>
                            <th>Name</th>
                            <th>Host ID</th>
                            <th>Destination</th>
                            <th>Message</th>
                            <th>Extra</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <nav aria-label="Log pagination" class="mt-4">
                    <ul class="pagination justify-content-center" id="logPagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        // Function to create log entry HTML
        function createLogEntry(log) {
            return `
                <div class="log-entry">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="log-level ${log.level.toLowerCase()}">${log.level}</span>
                            <span class="log-source ms-2">${log.source}</span>
                        </div>
                        <span class="log-time">${formatTimestamp(log.timestamp)}</span>
                    </div>
                    <div class="log-message">${log.message}</div>
                </div>
            `;
        }

        // Function to load logs
        function loadLogs() {
            const level = document.getElementById('logLevel').value;
            const source = document.getElementById('logSource').value;
            const timeRange = document.getElementById('timeRange').value;

            fetch(`/api/logs?level=${level}&source=${source}&timeRange=${timeRange}`)
                .then(response => response.json())
                .then(data => {
                    const logEntries = document.getElementById('logEntries');
                    logEntries.innerHTML = data.logs.map(log => createLogEntry(log)).join('');
                })
                .catch(error => {
                    console.error('Error loading logs:', error);
                    alert('Failed to load logs. Please try again.');
                });
        }

        // Function to refresh logs
        function refreshLogs() {
            loadLogs();
        }

        // Function to apply filters
        function applyFilters() {
            loadLogs();
        }

        // Function to export logs
        function exportLogs() {
            const level = document.getElementById('logLevel').value;
            const source = document.getElementById('logSource').value;
            const timeRange = document.getElementById('timeRange').value;

            fetch(`/api/logs/export?level=${level}&source=${source}&timeRange=${timeRange}`)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `security_logs_${new Date().toISOString()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                })
                .catch(error => {
                    console.error('Error exporting logs:', error);
                    alert('Failed to export logs. Please try again.');
                });
        }

        // Real-time filter for log table (multi-criteria, debounced)
        let filterTimeout = null;
        function filterLogTable() {
            if (filterTimeout) clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                const fLevel = document.getElementById('filterLevel').value.toLowerCase();
                const fSource = document.getElementById('filterSource').value.toLowerCase();
                const fTimeRange = document.getElementById('filterTimeRange').value;
                const fSearch = document.getElementById('filterSearch').value.toLowerCase();
                const fStart = document.getElementById('filterStartTime').value;
                const fEnd = document.getElementById('filterEndTime').value;
                const now = new Date();
                const rows = document.getElementById('logTable').querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    let show = true;
                    if (fLevel && cells[1].textContent.toLowerCase() !== fLevel) show = false;
                    if (fSource && cells[2].textContent.toLowerCase() !== fSource) show = false;
                    // Custom time range
                    if (fStart || fEnd) {
                        const logTime = new Date(cells[0].textContent);
                        if (fStart) {
                            const start = new Date(fStart);
                            if (logTime < start) show = false;
                        }
                        if (fEnd) {
                            const end = new Date(fEnd);
                            if (logTime > end) show = false;
                        }
                    } else if (fTimeRange && fTimeRange !== 'all') {
                        const logTime = new Date(cells[0].textContent);
                        let threshold = new Date(now);
                        if (fTimeRange === '1h') threshold.setHours(now.getHours() - 1);
                        else if (fTimeRange === '6h') threshold.setHours(now.getHours() - 6);
                        else if (fTimeRange === '24h') threshold.setHours(now.getHours() - 24);
                        else if (fTimeRange === '7d') threshold.setDate(now.getDate() - 7);
                        else if (fTimeRange === '30d') threshold.setDate(now.getDate() - 30);
                        if (logTime < threshold) show = false;
                    }
                    if (fSearch) {
                        let found = false;
                        cells.forEach(cell => {
                            if (cell.textContent.toLowerCase().includes(fSearch)) found = true;
                        });
                        if (!found) show = false;
                    }
                    row.style.display = show ? '' : 'none';
                });
                // Only reset to page 1 when filters change
                currentPage = 1;
                renderPaginatedLogs();
            }, 100);
        }

        // Pagination state
        let currentPage = 1;
        const logsPerPage = 100;

        // Render paginated logs
        function renderPaginatedLogs() {
            const rows = Array.from(document.getElementById('logTable').querySelectorAll('tbody tr'));
            let visibleRows = rows.filter(row => row.style.display !== 'none');
            // Hide all rows first
            rows.forEach(row => row.style.display = 'none');
            // Show only rows for current page
            const start = (currentPage - 1) * logsPerPage;
            const end = start + logsPerPage;
            visibleRows.slice(start, end).forEach(row => row.style.display = '');
            renderPagination(visibleRows.length);
        }

        // Render pagination controls
        function renderPagination(totalVisible) {
            const totalPages = Math.ceil(totalVisible / logsPerPage) || 1;
            const pagination = document.getElementById('logPagination');
            pagination.innerHTML = '';
            // Previous
            const prev = document.createElement('li');
            prev.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
            prev.innerHTML = `<a class="page-link" href="#">Previous</a>`;
            prev.onclick = function(e) { e.preventDefault(); if (currentPage > 1) { currentPage--; renderPaginatedLogs(); } };
            pagination.appendChild(prev);
            // Page numbers (show at most 5, with ellipsis)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            if (currentPage <= 3) { endPage = Math.min(5, totalPages); }
            if (currentPage >= totalPages - 2) { startPage = Math.max(1, totalPages - 4); }
            if (startPage > 1) {
                const first = document.createElement('li');
                first.className = 'page-item';
                first.innerHTML = `<a class="page-link" href="#">1</a>`;
                first.onclick = function(e) { e.preventDefault(); currentPage = 1; renderPaginatedLogs(); };
                pagination.appendChild(first);
                if (startPage > 2) {
                    const dots = document.createElement('li');
                    dots.className = 'page-item disabled';
                    dots.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(dots);
                }
            }
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === currentPage ? ' active' : '');
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.onclick = function(e) { e.preventDefault(); currentPage = i; renderPaginatedLogs(); };
                pagination.appendChild(li);
            }
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('li');
                    dots.className = 'page-item disabled';
                    dots.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(dots);
                }
                const last = document.createElement('li');
                last.className = 'page-item';
                last.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
                last.onclick = function(e) { e.preventDefault(); currentPage = totalPages; renderPaginatedLogs(); };
                pagination.appendChild(last);
            }
            // Next
            const next = document.createElement('li');
            next.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
            next.innerHTML = `<a class="page-link" href="#">Next</a>`;
            next.onclick = function(e) { e.preventDefault(); if (currentPage < totalPages) { currentPage++; renderPaginatedLogs(); } };
            pagination.appendChild(next);
        }

        // Function to fetch real-time logs
        function fetchLogs() {
            fetch('/api/logs/realtime')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('logTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    if (data.logs) {
                        data.logs.forEach(log => {
                            const row = `<tr>
                                <td>${log.timestamp || ''}</td>
                                <td>${log.level || ''}</td>
                                <td>${log.source || ''}</td>
                                <td>${log.event_id || ''}</td>
                                <td>${log.process_id || ''}</td>
                                <td>${log.name || ''}</td>
                                <td>${log.host_id || ''}</td>
                                <td>${log.destination || ''}</td>
                                <td>${log.message || ''}</td>
                                <td>${log.extra ? JSON.stringify(log.extra) : ''}</td>
                            </tr>`;
                            tbody.innerHTML += row;
                        });
                        // After logs are loaded, re-apply filter and pagination, but preserve currentPage
                        const prevPage = currentPage;
                        filterLogTable();
                        // After filtering, check if currentPage is still valid
                        setTimeout(() => {
                            const rows = Array.from(document.getElementById('logTable').querySelectorAll('tbody tr'));
                            const visibleRows = rows.filter(row => row.style.display !== 'none');
                            const totalPages = Math.ceil(visibleRows.length / logsPerPage) || 1;
                            if (prevPage > totalPages) {
                                currentPage = totalPages;
                                renderPaginatedLogs();
                            } else {
                                currentPage = prevPage;
                                renderPaginatedLogs();
                            }
                        }, 120);
                    }
                });
        }

        // Load logs on page load
        document.addEventListener('DOMContentLoaded', fetchLogs);

        // Auto-refresh every 1 second
        setInterval(fetchLogs, 1000);
    </script>
</body>
</html> 