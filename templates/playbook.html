<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Playbooks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            padding-top: 20px;
        }
        .sidebar a {
            color: #fff;
            text-decoration: none;
            padding: 10px 15px;
            display: block;
        }
        .sidebar a:hover {
            background-color: #495057;
        }
        .sidebar a.active {
            background-color: #0d6efd;
        }
        .main-content {
            padding: 20px;
        }
        .playbook-card {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
        }
        .playbook-card h3 {
            margin-bottom: 10px;
            color: #0d6efd;
        }
        .playbook-card .tags {
            margin: 10px 0;
        }
        .playbook-card .tag {
            background-color: #e9ecef;
            padding: 3px 8px;
            border-radius: 3px;
            margin-right: 5px;
            font-size: 0.9em;
        }
        .playbook-card .steps {
            margin-top: 15px;
        }
        .playbook-card .step {
            background-color: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 3px;
        }
        .playbook-card .step-number {
            font-weight: bold;
            color: #0d6efd;
        }
        .playbook-card .actions {
            margin-top: 10px;
        }
        .playbook-card .action {
            background-color: #e9ecef;
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 3px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar">
                <h4 class="text-white text-center mb-4">Security Manager</h4>
                <a href="/" class="mb-2"><i class="fas fa-home me-2"></i> Dashboard</a>
                <a href="/eep" class="mb-2"><i class="fas fa-shield-alt me-2"></i> EEP</a>
                <a href="/log" class="mb-2"><i class="fas fa-list me-2"></i> Log</a>
                <a href="/playbook" class="active mb-2"><i class="fas fa-book me-2"></i> Playbook</a>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Security Playbooks</h2>
                    <button class="btn btn-primary" onclick="createNewPlaybook()">
                        <i class="fas fa-plus me-2"></i>New Playbook
                    </button>
                </div>

                <!-- Search and Filter -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search playbooks...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter">
                            <option value="all">All Categories</option>
                            <option value="Incident Response">Incident Response</option>
                            <option value="Threat Hunting">Threat Hunting</option>
                            <option value="Security Assessment">Security Assessment</option>
                        </select>
                    </div>
                </div>

                <!-- Playbooks List -->
                <div id="playbooksList">
                    <!-- Playbooks will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to create a new playbook
        function createNewPlaybook() {
            fetch('/api/open-playbook-script', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating new playbook');
            });
        }

        // Function to load playbooks
        function loadPlaybooks() {
            fetch('/api/playbooks')
                .then(response => response.json())
                .then(playbooks => {
                    const playbooksList = document.getElementById('playbooksList');
                    playbooksList.innerHTML = '';

                    if (playbooks.length === 0) {
                        playbooksList.innerHTML = '<div class="alert alert-info">No playbooks found. Create a new playbook to get started.</div>';
                        return;
                    }

                    playbooks.forEach(playbook => {
                        const playbookCard = createPlaybookCard(playbook);
                        playbooksList.appendChild(playbookCard);
                    });
                })
                .catch(error => {
                    console.error('Error loading playbooks:', error);
                    document.getElementById('playbooksList').innerHTML = 
                        '<div class="alert alert-danger">Error loading playbooks. Please try again.</div>';
                });
        }

        // Function to create a playbook card
        function createPlaybookCard(playbook) {
            const card = document.createElement('div');
            card.className = 'playbook-card';
            
            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <h3>${playbook.title}</h3>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editPlaybook('${playbook.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePlaybook('${playbook.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <p class="text-muted">${playbook.description}</p>
                <div class="tags">
                    ${playbook.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                </div>
                <div class="steps">
                    ${playbook.steps.map((step, index) => `
                        <div class="step">
                            <div class="step-number">Step ${index + 1}</div>
                            <div class="step-description">${step.description}</div>
                            ${step.actions ? `
                                <div class="actions">
                                    ${step.actions.map(action => `
                                        <div class="action">${action}</div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            return card;
        }

        // Function to edit a playbook
        function editPlaybook(playbookId) {
            // TODO: Implement edit functionality
            alert('Edit functionality coming soon!');
        }

        // Function to delete a playbook
        function deletePlaybook(playbookId) {
            if (confirm('Are you sure you want to delete this playbook?')) {
                fetch(`/api/playbooks/${playbookId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        loadPlaybooks(); // Reload the playbooks list
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting playbook');
                });
            }
        }

        // Search and filter functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            filterPlaybooks(searchTerm, category);
        });

        document.getElementById('categoryFilter').addEventListener('change', function(e) {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const category = e.target.value;
            filterPlaybooks(searchTerm, category);
        });

        function filterPlaybooks(searchTerm, category) {
            const cards = document.querySelectorAll('.playbook-card');
            cards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const description = card.querySelector('p').textContent.toLowerCase();
                const tags = Array.from(card.querySelectorAll('.tag')).map(tag => tag.textContent.toLowerCase());
                const playbookCategory = card.dataset.category;

                const matchesSearch = title.includes(searchTerm) || 
                                    description.includes(searchTerm) || 
                                    tags.some(tag => tag.includes(searchTerm));
                const matchesCategory = category === 'all' || playbookCategory === category;

                card.style.display = matchesSearch && matchesCategory ? 'block' : 'none';
            });
        }

        // Load playbooks when the page loads
        document.addEventListener('DOMContentLoaded', loadPlaybooks);

        // Refresh playbooks every 30 seconds
        setInterval(loadPlaybooks, 30000);
    </script>
</body>
</html> 